name: Render deploy

on:
  push:
    branches: [ main ]

# This workflow only triggers the deploy call to Render. Building and pushing
# the image is handled by the separate `Publish Docker image` workflow.
# The job is guarded by an `if` so it will be skipped (not fail) when the
# required secrets are not present.
jobs:
  trigger-deploy:
    if: ${{ secrets.RENDER_API_KEY && secrets.RENDER_SERVICE_ID }}
    runs-on: ubuntu-latest
    env:
      IMAGE: ghcr.io/${{ github.repository }}
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - name: Trigger Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          IMAGE_REF: ${{ env.IMAGE }}:${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          echo "Triggering Render deploy for service ${RENDER_SERVICE_ID} with image ${IMAGE_REF}"
          PAYLOAD=$(printf '{"message":"%s","metadata":{"image":"%s"}}' "Deploy from GitHub Actions" "$IMAGE_REF")
          resp=$(curl -s -w "\n%{http_code}" -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          body=$(echo "$resp" | sed '$d')
          code=$(echo "$resp" | tail -n1)
          echo "Render response code: $code"
          echo "Render response body: $body"
          if [ "$code" -lt 200 ] || [ "$code" -ge 300 ]; then
            echo "Render deploy request failed (status: $code)"
            exit 1
          fi
