name: Render deploy

on:
  push:
    branches: [ main ]

# This workflow only triggers the deploy call to Render. Building and pushing
# the image is handled by the separate `Publish Docker image` workflow.
# The job is guarded by an `if` so it will be skipped (not fail) when the
# required secrets are not present.
jobs:
  trigger-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        id: check
        run: |
          # Determine whether we have the Render secrets available at runtime
          if [ -z "${{ secrets.RENDER_API_KEY }}" ] || [ -z "${{ secrets.RENDER_SERVICE_ID }}" ]; then
            echo "Missing RENDER_API_KEY or RENDER_SERVICE_ID; skipping deploy"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Render deploy
        if: steps.check.outputs.should_deploy == 'true'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          REPO_NAME: ${{ github.event.repository.name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          # Decide image reference: prefer Docker Hub when credentials are provided
          if [ -n "${DOCKERHUB_USERNAME:-}" ] && [ -n "${DOCKERHUB_TOKEN:-}" ]; then
            IMAGE_REF="docker.io/${DOCKERHUB_USERNAME}/${REPO_NAME}:${GITHUB_SHA}"
          else
            IMAGE_REF="ghcr.io/${GITHUB_REPOSITORY}:${GITHUB_SHA}"
          fi
          echo "Triggering Render deploy for service ${RENDER_SERVICE_ID} with image ${IMAGE_REF}"
          PAYLOAD=$(printf '{"message":"%s","metadata":{"image":"%s"}}' "Deploy from GitHub Actions" "$IMAGE_REF")
          resp=$(curl -s -w "\n%{http_code}" -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          body=$(echo "$resp" | sed '$d')
          code=$(echo "$resp" | tail -n1)
          echo "Render response code: $code"
          echo "Render response body: $body"
          if [ "$code" -lt 200 ] || [ "$code" -ge 300 ]; then
            echo "Render deploy request failed (status: $code)"
            exit 1
          fi
